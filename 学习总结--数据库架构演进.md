# 数据库架构演进

## 主从复制

### 定义

>是用来建立一个和主数据库完全一样的数据库环境，称为从数据库；主数据库一般是准实时的业务数据库。从数据库做数据的热备，作为后备数据库，主数据库服务器故障后，可切换到从数据库继续工作，避免数据丢失。保证了数据库的高可用。

### 主从复制的问题，保证主从数据一致性

- 在从表中写成功后才返回成功。
- cache中设一个key记录着一次写的数据,然后设置一个同步时间，如果在这个时间内，有一个读请求,看看对应的key有没有相关数据,有的话,说明数据近期发生过写事件，这样key的数据就继续读主库，否则就读从库。

## 读写分离

### 定义

> 读写分离 一般有至少两个数据库 一个主数据库，一个从数据库,主数据库用来写操作，从数据库用来读操作。

### 读写分离优点

- 主从只负责各自的写和读，极大程度的缓解X锁和S锁争用（如果读操作被设置为锁的话，Innodb一般不会对select加锁，不管是不是在事务中。）
- 分摊读取。假如我们有1主3从，不考虑上述1中提到的从库单方面设置，假设现在1 分钟内有10条写入，150条读取。那么，1主3从相当于共计40条写入，而读取总数没变，因此平均下来每台服务器承担了10条写入和50条读取（主库不 承担读取操作）。因此，虽然写入没变，但是读取大大分摊了，提高了系统性能。另外，当读取被分摊后，又间接提高了写入的性能。所以，总体性能提高了，说白 了就是拿机器和带宽换性能。

## 分库分表

### 定义

> **其主要目的**是为了解决单库单表数据过多，查询缓慢等问题，解决数据库扩展性问题。
>
> - 分库：垂直切分，根据业务切分数据库。
> - 分表：水平切分，将一张大表拆分成相同的多个表放在不同的数据库中。

### 分库分表存在的问题

#### **水平分表出现的id自增问题**

- java中的uuid
- 不同数据库步长不同自增
- 通过redis的单线程取到自增的id后加到不同数据库中
- 雪花算法，是通过不同机器的系统时间和机器编号计算的
- 美团的leaf

#### **垂直分表出现的多表join,order问题**

- 字段冗余（各个表中有相同的常用字段）
- 系统层组装（缓存中台）

#### **分布式事务**

- 两阶段提交法
- 借助消息队列实现最终一致性