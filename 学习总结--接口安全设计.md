# 接口安全性设计

## 接口安全性问题

- 接口访问认证问题,主要解决谁可以使用接口
- 数据数据传输安全,主要解决接口数据被篡改
- 接口重复调用(接口的幂等性设计、dos攻击)

## 接口安全性问题解决方案

- 接口访问认证：Token+timestamp
- 数据传输安全：Sign+timestamp
- 接口重复调用解决方案

## 采用机制

### Token机制

#### 定义

> Token授权机制：用户使用用户名密码登录后服务器给客户端返回一个Token（通常是UUID），并将Token-UserId以键值对的形式存放在缓存服务器中。服务端接收到请求后进行Token验证，如果Token不存在，说明请求无效。Token是客户端访问服务端的凭证

## sign机制（签名机制）

#### 定义

> 将 Token 和 时间戳 加上其他请求参数再用MD5或SHA-1算法（可根据情况加点盐）加密，加密后的数据就是本次请求的签名sign，服务端接收到请求后以同样的算法得到签名，并跟当前的签名进行比对，如果不一样，说明参数被更改过，直接返回错误标识。签名机制保证了数据不会被篡改。

## timestamp机制

> 用户每次请求都带上当前时间的时间戳timestamp，服务端接收到timestamp后跟当前时间进行比对，如果时间差大于一定时间（比如5分钟），则认为该请求失效。时间戳超时机制是防御DOS攻击的有效手段

## 接口幂等性设计

### 非幂等性操作

- POST不是幂等操作，因为一次请求添加一份新资源，二次请求则添加了两份新资源，多次请求会产生不同的结果，因此POST不是幂等操作。

### 天然幂等性

- GET，PUT，DELETE都是幂等操作，而POST不是

### 幂等实现方法

- token机制（防止重复提交）
- 全局唯一ID
- 唯一索引
- 分布式锁：在执行某段流程之前,根据某个标志获取分布式锁,保证了同一时间该流程只有一个能被执行
- 状态机控制

### 防止接口重复调用

- session + Token
- token + sign + timestamps (sign作为key存入redis,并设置超时时间和token超时时间一致,不推荐)
- redis+注解 + 拦截器(待实现)
- redis+注解 + AOP(待实现)

## 认证方式

### OAuth2.0

### JWT Token（待实现）

#### 构成

- 头部（header）
- 有效载荷（Payload）
- 签名（signature）

##### header

- typ:token的类型，这里固定为JWT
- alg：使用的hash算法，例如：HMAC SHA256或者RSA

##### payload

- 存储需要传递的信息，如用户ID、用户名等
- 还包含元数据，如过期时间、发布人等
- 与header不同，payload可以加密

##### signature

- 对header和payload部分进行签名
- 保证token在传输的过程中没有被篡改或者损坏

#### 工作原理

>客户端通过请求将用户名和密码传给服务端，服务端将用户名和密码进行核对，核对成功后将用户id等其他信息作为jwt的有效载荷（payload）与头部进行base64编码形成jwt（字符串），后端将这段字符串作为登陆成功的返回结果返回给前端。前端将其保存在localstroage或sessionstroage里，退出登录时，删除JWT字符串就可以。每次请求，前端都会把JWT作为authorization请求头传给后端，后端进行检查。

